<!doctype html>
<html>
	<head>
		<title>426 Final Project</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <script src="libjs/three.js"></script>
		<script src="libjs/stats.min.js"></script>
		<link  href="css/main.css" rel="stylesheet"/>
	</head>

	<body>
		<!-- Adapted from https://pxwise.github.io/2015/05/31/Getting-Started-with-THREE.js.html -->
	  <!-- <div id="container"></div> -->

		<!-- Vertex Shader -->
		<script id="vertexShader" type="x-shader/x-vertex">
			uniform float time;
			uniform vec3 gravity;

			varying vec2 vUv;
			varying vec3 vNormal;

			const float spacing = 12.0;

			void main()	{
				// vUv = uv;

				vec3 displacement 	= vec3( 0.0, 0.0, 0.0 );
				vec3 forceDirection = vec3( 0.0, 0.0, 0.0 );

				// "wind"
				forceDirection.x = sin(       time + position.x * 0.05 ) * 0.2;
				forceDirection.y = cos( 0.7 * time + position.y * 0.04 ) * 0.2;
				forceDirection.z = sin( 0.7 * time + position.z * 0.04 ) * 0.2;

				// "gravity"
				displacement = gravity + forceDirection;

				// float displacementFactor = pow(offset, 3.0);

				vec3 aNormal = normal;
				aNormal.xyz += displacement;
				// aNormal.xyz += displacement * displacementFactor;

				// move outwards depending on offset(layer) and normal + force + gravity
				vec3 animated = vec3( position.x, position.y, position.z ) + ( normalize(aNormal) * spacing );
				// vec3 animated = vec3( position.x, position.y, position.z ) + ( normalize(aNormal) * offset * spacing );

				vNormal = normalize( normal * aNormal );
				vUv = uv * 20.0;
				vec4 mvPosition = modelViewMatrix * vec4( animated, 1.0 );

				gl_Position = projectionMatrix * mvPosition;
				// gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			}
		</script>


		<!-- Fragment Shader -->
		<script id="fragmentShader" type="x-shader/x-fragment">

			uniform sampler2D colorMap;
			uniform sampler2D hairMap;
			uniform vec3 color;

			varying vec2 vUv;
			varying vec3 vNormal;

			void main() {
				vec4 hairColor = texture2D( hairMap, vec2(vUv.s, vUv.t) );
				vec4 col = texture2D( colorMap, vec2(vUv.s * 0.2, vUv.t * 0.2) );

				// discard no hairs + above the max length
				if (hairColor.a <= 0.0) {
					discard;
				}

				gl_FragColor = vec4( color * col.xyz, 1.0);
				// gl_FragColor = texture2D( colorMap, vUv );
		  	// gl_FragColor = vec4(0.6, 1.0, 1.0, 0.5);
			}
		</script>

		<!-- Main -->
		<!-- Adapted from https://threejs.org/examples/webgl_loader_json_claraio.html -->
	  <script>

		  (function() {
		    var scene 		= new THREE.Scene();

				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.z = 1000;
				camera.lookAt(scene.position);
				scene.add( camera );

				// diffuse color
				colorMap = THREE.ImageUtils.loadTexture( "11133-v4.jpg" );
				colorMap.wrapS = colorMap.wrapT = THREE.RepeatWrapping;

				// load a texture, set wrap mode to repeat
				// var texture = new THREE.TextureLoader().load( generateTexture() );
				// texture.wrapS = THREE.RepeatWrapping;
				// texture.wrapT = THREE.RepeatWrapping;
				// texture.repeat.set( 4, 4 );
				texture = new THREE.Texture( generateTexture() );
				texture.needsUpdate = true;
				colorMap.wrapS = colorMap.wrapT = THREE.RepeatWrapping;

		    var renderer 	= new THREE.WebGLRenderer();
				var geometry = new THREE.SphereGeometry( 300, 32, 32 );
				// var geometry 	= new THREE.BoxGeometry(700, 700, 700, 10, 10, 10);
				// var geometry = new THREE.SphereGeometry( 100, 32, 32 );
				// var geometry = new THREE.TorusGeometry( 300, 70, 16, 100 )
		    var startTime = Date.now();
				var gravity = new THREE.Vector3( 0, -0.75, 0 );

				var uniforms = {
					color:      { type: "c", value: new THREE.Color( 0xffffff ) },
					hairMap:    { type: "t", value: texture },
					colorMap:   { type: "t", value: colorMap },
					time: 			{ type: "f", value: 1.0 },
					// offset:			{ type: "f", value: shells },
					// globalTime:	{ type: "f", value: shaderTime },
					gravity: 		{ type: "v3", value: gravity },
				};

		    var material = new THREE.ShaderMaterial( {
					uniforms: 			uniforms,
					vertexShader:   document.getElementById( 'vertexShader' ).textContent,
					fragmentShader: document.getElementById( 'fragmentShader' ).textContent,
					transparent: 		true,
					fog: 						true,
				});

		    console.log(material);
				var cube = new THREE.Mesh( geometry, material );

		    renderer.setSize(window.innerWidth, window.innerHeight);
		    document.body.appendChild(renderer.domElement);
				scene.add( cube );

		    function render() {
		      requestAnimationFrame(render);
					// cube.rotation.x += 0.001;
		      // cube.rotation.y += 0.001;
		      cube.rotation.x += 0.000;
		      cube.rotation.y += 0.000;
		      var elapsedMilliseconds = Date.now() - startTime;
					var elapsedSeconds = elapsedMilliseconds / 1000.;
					uniforms.time.value = 60. * elapsedSeconds;
		      renderer.render(scene, camera);
		    };

				function generateTexture() {
					var canvas = document.createElement( 'canvas' );
					canvas.width = 256;
					canvas.height = 256;
					var context = canvas.getContext( '2d' );
					for ( var i = 0; i < 20000; ++i ) {
						// r = hair 1/0
						// g = length
						// b = darkness
						context.fillStyle = "rgba(255," + Math.floor( Math.random() * 255 ) + ","+ Math.floor( Math.random() * 255 ) +",1)";
						context.fillRect( ( Math.random() * canvas.width ), ( Math.random() * canvas.height ), 2, 2 );
					}

					return canvas;
				}

		    render();
		  }());

	  </script>

	</body>
</html>
